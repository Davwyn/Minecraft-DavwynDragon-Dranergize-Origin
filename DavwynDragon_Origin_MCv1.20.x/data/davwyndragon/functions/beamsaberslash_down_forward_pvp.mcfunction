execute run tag @s add dragonattacking
execute run tag @s add dragonselfattacking

execute at @s positioned ^ ^1 ^1 as @e[distance=..10.0,nbt={cardinal_components:{"apoli:powers":{"Powers":[{Type:"davwyndragon:shake_effect_resource"}]}}}] if entity @s run resource set @s davwyndragon:shake_effect_resource 2
execute at @s positioned ^ ^1 ^1 as @e[distance=..10.0,nbt={ForgeCaps:{"apoli:powers":{"Powers":[{Type:"davwyndragon:shake_effect_resource"}]}}}] if entity @s run resource set @s davwyndragon:shake_effect_resource 2

execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s as @e[distance=..10.0,tag=dragonattacking,sort=nearest,limit=1,nbt={cardinal_components:{"apoli:powers":{"Powers":[{Type:"davwyndragon:beamsaberclaw_hit_effect_resource"}]}}}] if entity @s run resource set @s davwyndragon:beamsaberclaw_hit_effect_resource 2
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s as @e[distance=..10.0,tag=dragonattacking,sort=nearest,limit=1,nbt={ForgeCaps:{"apoli:powers":{"Powers":[{Type:"davwyndragon:beamsaberclaw_hit_effect_resource"}]}}}] if entity @s run resource set @s davwyndragon:beamsaberclaw_hit_effect_resource 2

execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run summon marker ~ ~1 ~ {CustomNameVisible:0b,NoGravity:1b,Invisible:1b,Tags:["DavwynDragonLight"],NoAI:1b}

execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s if entity @e[type=player,sort=nearest,limit=1,distance=..30,nbt={DeathTime:0s}] run data modify entity @s AngryAt set from entity @e[type=player,sort=nearest,limit=1,distance=..30,nbt={DeathTime:0s}] UUID
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s if entity @s at @s if entity @e[type=player,sort=nearest,limit=1,distance=..30,nbt={DeathTime:0s}] run data modify entity @s AngryTime set value 10

execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run particle minecraft:lava ^ ^1 ^ 0.2 0.2 0.2 0 3 force
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run particle minecraft:end_rod ^ ^1 ^ 0.2 0.2 0.2 0.5 3 force
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run particle minecraft:flash ^ ^1 ^ 0.5 0.5 0.5 0 1 force
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run particle minecraft:ash ^ ^1 ^ 1.0 1.0 1.0 0 5 force

execute at @s positioned ^ ^1 ^1 as @e[type=!player,tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s as @e[tag=energizedragon,type=player,distance=..40.0] as @s at @s run xp add @s 2

execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run resource change @e[tag=dragonattacking,type=player,distance=..10.0,sort=nearest,limit=1] davwyndragon:rage_over_resource 4
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run resource change @e[tag=dragonattacking,type=player,distance=..10.0,sort=nearest,limit=1] davwyndragon:ultimate_resource 2
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run damage @s 2 davwyndragon:dragon_attack by @e[tag=dragonattacking,type=player,distance=..20.0,sort=nearest,limit=1]

execute if entity @s[y_rotation=-22..22] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_1
execute if entity @s[y_rotation=23..67] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_2
execute if entity @s[y_rotation=68..112] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_3
execute if entity @s[y_rotation=113..157] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_4
execute if entity @s[y_rotation=158..180] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_5
execute if entity @s[y_rotation=-180..-158] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_5
execute if entity @s[y_rotation=-157..-113] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_6
execute if entity @s[y_rotation=-112..-68] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_7
execute if entity @s[y_rotation=-67..-23] at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s run tag @s add dragon_push_down_forward_8
execute at @s positioned ^ ^1 ^1 as @e[tag=!dragonselfattacking,distance=..5.0,type=!minecraft:armor_stand,type=!minecraft:marker,tag=!DavwynDragonLight,tag=!DavwynDragonLightEven,tag=!DavwynDragonLightOdd,tag=!DavwynDragonGlowEven,tag=!DavwynDragonGlowOdd,sort=nearest,nbt={DeathTime:0s}] if entity @s at @s as @p run schedule function davwyndragon:dragon_push_down_forward 2t

execute at @e[type=minecraft:marker,tag=DavwynDragonLight,sort=nearest] run setblock ~ ~ ~ minecraft:light keep
execute run schedule function davwyndragon:lightclear 2t

execute run tag @s remove dragonselfattacking
execute run tag @s remove dragonattacking